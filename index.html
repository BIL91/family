<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProChat</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" rel="stylesheet">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js"></script>
    <style>
        body { height: 100vh; overflow: hidden; }
        #chatContainer { display: none; height: 100vh; }
        .chat-message { max-width: 70%; }
        .own-message { background-color: #d1e7dd; }
        .other-message { background-color: #f8f9fa; }
        #onlineUsers { max-height: 100%; overflow-y: auto; }
        .tooltip-inner { max-width: 200px; }
    </style>
</head>
<body class="bg-light">
    <!-- Name Prompt Modal -->
    <div id="nameModal" class="modal fade show d-block" tabindex="-1" aria-labelledby="nameModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="nameModalLabel">Welcome to ProChat</h5>
                </div>
                <div class="modal-body">
                    <input id="nameInput" type="text" class="form-control" placeholder="Enter your name..." aria-label="Display name">
                </div>
                <div class="modal-footer">
                    <button id="nameSubmit" class="btn btn-primary"><i class="fas fa-sign-in-alt"></i></button>
                </div>
            </div>
        </div>
    </div>

    <!-- Chat Interface -->
    <div id="chatContainer" class="container-fluid h-100">
        <div class="row h-100">
            <!-- Online Users Sidebar -->
            <div class="col-3 bg-white border-end p-0">
                <div class="p-3 bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-users me-2"></i>Online Users</h5>
                </div>
                <ul id="onlineUsers" class="list-group list-group-flush"></ul>
            </div>
            <!-- Chat Area -->
            <div class="col-9 d-flex flex-column h-100 p-0">
                <div class="p-3 bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-comment-dots me-2"></i>ProChat</h5>
                    <span id="userName" class="badge bg-secondary"></span>
                </div>
                <div id="messages" class="flex-grow-1 p-3 overflow-y-auto"></div>
                <div id="typingIndicator" class="p-2 text-muted small d-none"></div>
                <form id="messageForm" class="p-3 bg-white border-top d-flex">
                    <input id="messageInput" type="text" class="form-control me-2" placeholder="Type a message..." aria-label="Message">
                    <button type="submit" id="sendButton" class="btn btn-primary"><i class="fas fa-paper-plane"></i></button>
                </form>
            </div>
        </div>
    </div>

    <!-- Firebase Initialization -->
    <script>
        // Firebase config and initialization
        const firebaseConfig = {
            // Replace with your Firebase config
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        const app = firebase.initializeApp(firebaseConfig);
        window.db = firebase.firestore(); // Expose db globally
    </script>

    <!-- Core Chat Functions -->
    <script>
        function saveMessagesLocally(messages) {
            localStorage.setItem('chatMessages', JSON.stringify(messages.slice(-50)));
        }

        function loadMessagesLocally() {
            return JSON.parse(localStorage.getItem('chatMessages') || '[]');
        }

        function displayMessage(id, msg, currentDisplayName) {
            const messages = document.getElementById('messages');
            const isOwn = msg.displayName === currentDisplayName;
            const div = document.createElement('div');
            div.className = `chat-message mb-2 p-2 rounded ${isOwn ? 'own-message ms-auto' : 'other-message border'}`;
            const time = msg.createdAt ? new Date(msg.createdAt.toDate()).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';
            div.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <strong>${msg.displayName}</strong>
                    <small class="text-muted">${time}</small>
                </div>
                <p class="mb-1">${msg.text}</p>
                <div class="d-flex align-items-center">
                    ${msg.reactions.map((r) => `<span class="me-1">${r.reaction}</span>`).join('')}
                    <button class="btn btn-sm btn-link p-0" onclick="addReaction('${id}')" data-bs-toggle="tooltip" title="Like"><i class="fas fa-thumbs-up"></i></button>
                </div>
            `;
            messages.appendChild(div);
        }

        async function sendMessage(text, displayName, userId) {
            if (text.trim()) {
                const messageRef = await window.db.collection('messages').add({
                    text,
                    createdAt: new Date(),
                    displayName,
                    reactions: [],
                });
                await window.db.collection('users').doc(userId).update({
                    isTyping: false,
                    lastSeen: new Date(),
                });
                return messageRef.id;
            }
        }

        async function addReaction(messageId) {
            const messageRef = window.db.collection('messages').doc(messageId);
            await messageRef.update({
                reactions: firebase.firestore.FieldValue.arrayUnion({ reaction: '👍' }),
            });
        }

        function updateOnlineUsers(users, currentDisplayName) {
            const onlineUsers = document.getElementById('onlineUsers');
            onlineUsers.innerHTML = '';
            users.forEach(({ displayName, isTyping }) => {
                const li = document.createElement('li');
                li.className = 'list-group-item d-flex align-items-center';
                li.innerHTML = `
                    <i class="fas fa-circle text-success me-2 ${isTyping ? 'fa-beat' : ''}"></i>
                    ${displayName === currentDisplayName ? `${displayName} (You)` : displayName}
                `;
                onlineUsers.appendChild(li);
            });
        }
    </script>

    <!-- Main App Logic -->
    <script>
        (function () {
            // DOM Elements
            const nameModal = document.getElementById('nameModal');
            const nameInput = document.getElementById('nameInput');
            const nameSubmit = document.getElementById('nameSubmit');
            const chatContainer = document.getElementById('chatContainer');
            const userName = document.getElementById('userName');
            const messages = document.getElementById('messages');
            const messageForm = document.getElementById('messageForm');
            const messageInput = document.getElementById('messageInput');
            const typingIndicator = document.getElementById('typingIndicator');

            // State
            let displayName = '';
            const userId = Math.random().toString(36).substring(2);
            let isTyping = false;

            // Expose addReaction globally
            window.addReaction = addReaction;

            // Load local messages
            const localMessages = loadMessagesLocally();
            localMessages.forEach((msg) => displayMessage(msg.id || Math.random().toString(36), msg, displayName));

            // Initialize Bootstrap tooltips
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map((tooltipTriggerEl) => new bootstrap.Tooltip(tooltipTriggerEl));

            // Show name prompt
            nameModal.classList.add('d-block');

            // Handle name submission
            nameSubmit.onclick = () => {
                displayName = nameInput.value.trim();
                if (displayName) {
                    nameModal.classList.remove('d-block');
                    chatContainer.style.display = 'block';
                    userName.textContent = `You: ${displayName}`;
                    initializeChat();
                } else {
                    alert('Please enter a name!');
                }
            };

            function initializeChat() {
                // Set user online
                window.db.collection('users').doc(userId).set({
                    displayName,
                    isTyping: false,
                    online: true,
                    lastSeen: new Date(),
                });

                // Clean up on unload
                window.addEventListener('beforeunload', () => {
                    window.db.collection('users').doc(userId).update({
                        online: false,
                        lastSeen: new Date(),
                    });
                });

                // Fetch messages
                window.db.collection('messages')
                    .orderBy('createdAt')
                    .limit(50)
                    .onSnapshot((snapshot) => {
                        messages.innerHTML = '';
                        const fetchedMessages = [];
                        snapshot.forEach((doc) => {
                            const msg = { id: doc.id, ...doc.data() };
                            displayMessage(doc.id, msg, displayName);
                            fetchedMessages.push(msg);
                        });
                        saveMessagesLocally(fetchedMessages);
                        messages.scrollTop = messages.scrollHeight;
                    });

                // Fetch online users and typing indicators
                window.db.collection('users')
                    .where('online', '==', true)
                    .onSnapshot((snapshot) => {
                        const users = [];
                        const typingUsers = [];
                        snapshot.forEach((doc) => {
                            const data = doc.data();
                            users.push(data);
                            if (data.isTyping && data.displayName !== displayName) {
                                typingUsers.push(data.displayName);
                            }
                        });
                        updateOnlineUsers(users, displayName);
                        if (typingUsers.length > 0) {
                            typingIndicator.textContent = `${typingUsers.join(', ')} ${typingUsers.length > 1 ? 'are' : 'is'} typing...`;
                            typingIndicator.classList.remove('d-none');
                        } else {
                            typingIndicator.classList.add('d-none');
                        }
                    });

                // Handle message submission
                messageForm.onsubmit = (e) => {
                    e.preventDefault();
                    sendMessage(messageInput.value, displayName, userId);
                    messageInput.value = '';
                    isTyping = false;
                };

                // Handle typing
                messageInput.oninput = () => {
                    const typing = messageInput.value.trim() !== '';
                    if (typing !== isTyping) {
                        isTyping = typing;
                        window.db.collection('users').doc(userId).update({
                            isTyping,
                            lastSeen: new Date(),
                        });
                    }
                };
            }
        })();
    </script>
    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
